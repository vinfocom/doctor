generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// Enums matched to DB names and values
enum Role {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  PATIENT

  @@map("users_role")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  BOOKED
}

enum ClinicStatus {
  ACTIVE
  INACTIVE
}

enum DoctorStatus {
  ACTIVE
  INACTIVE
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED

  @@map("slots_slot_status")
}

model users {
  user_id    Int       @id @default(autoincrement())
  name       String?   @db.VarChar(255)
  email      String?   @unique @db.VarChar(255)
  password   String?   @db.VarChar(255)
  role       Role
  created_at DateTime? @default(now()) @db.Timestamp(0)

  admin       admins?
  doctor      doctors?
  user_tokens user_tokens[]
}

model admins {
  admin_id   Int       @id @default(autoincrement())
  user_id    Int?      @unique
  created_at DateTime? @default(now()) @db.Timestamp(0)

  user     users? @relation(fields: [user_id], references: [user_id])
  clinics  clinics[]
  doctors  doctors[]
  patients patients[]
  slots    slots[]
  appointments appointment[]
  schedules doctor_clinic_schedule[]
}

model doctors {
  doctor_id       Int          @id @default(autoincrement())
  doctor_name     String?      @db.VarChar(255)
  phone           String?      @db.VarChar(255)
  status          DoctorStatus?
  admin_id        Int
  user_id         Int?         @unique
  whatsapp_number String?      @db.VarChar(255)

  admin     admins?                 @relation(fields: [admin_id], references: [admin_id])
  user      users?                  @relation(fields: [user_id], references: [user_id])
  schedules doctor_clinic_schedule[]
  appointments appointment[]
  clinics      clinics[]
  patients     patients[]
  whatsapp_numbers doctor_whatsapp_numbers[]
}

model doctor_whatsapp_numbers {
  id              Int      @id @default(autoincrement())
  doctor_id       Int
  whatsapp_number String   @db.VarChar(255)
  is_primary      Boolean  @default(false)
  created_at      DateTime @default(now()) @db.Timestamp(0)

  doctor          doctors  @relation(fields: [doctor_id], references: [doctor_id], onDelete: Cascade)
}

model clinics {
  clinic_id   Int          @id @default(autoincrement())
  clinic_name String?      @db.VarChar(255)
  phone       String?      @db.VarChar(255)
  status      ClinicStatus?
  admin_id    Int
  doctor_id   Int?
  location    String?      @db.VarChar(255)

  admin     admins?                 @relation(fields: [admin_id], references: [admin_id])
  doctor    doctors?                @relation(fields: [doctor_id], references: [doctor_id])
  schedules doctor_clinic_schedule[]
  appointments appointment[]
}

model patients {
  patient_id   Int     @id @default(autoincrement())
  full_name    String? @db.VarChar(255)
  age          Int?
  gender       String? @db.VarChar(50)
  admin_id     Int
  doctor_id    Int?
  patient_type String? @db.VarChar(50)
  reason       String? @db.VarChar(255)
  mode         String? @db.VarChar(255)
  phone        String? @db.VarChar(255)

  admin        admins?       @relation(fields: [admin_id], references: [admin_id])
  doctor       doctors?      @relation(fields: [doctor_id], references: [doctor_id])
  appointments appointment[]
}

model appointment {
  appointment_id Int                @id @default(autoincrement())
  patient_id     Int?
  slot_id        Int?
  doctor_id      Int?
  clinic_id      Int?
  admin_id       Int?
  status         AppointmentStatus?
  symptoms       String?            @db.Text
  mode           String?            @db.Text
  created_at     DateTime?          @default(now()) @db.Timestamp(0)
  
  patient patients? @relation(fields: [patient_id], references: [patient_id])
  doctor  doctors?  @relation(fields: [doctor_id], references: [doctor_id])
  clinic  clinics?  @relation(fields: [clinic_id], references: [clinic_id])
  slot    slots?    @relation(fields: [slot_id], references: [slot_id])
  admin   admins?   @relation(fields: [admin_id], references: [admin_id])

  @@map("appointments")
}

model slots {
  slot_id     Int         @id @default(autoincrement())
  schedule_id Int?
  admin_id    Int?
  slot_date   DateTime?   @db.Date
  slot_time   DateTime?   @db.Time(0)
  slot_status SlotStatus? @default(AVAILABLE)

  schedule     doctor_clinic_schedule? @relation(fields: [schedule_id], references: [schedule_id])
  admin        admins?       @relation(fields: [admin_id], references: [admin_id])
  appointments appointment[]
}

model doctor_clinic_schedule {
  schedule_id    Int      @id @default(autoincrement())
  doctor_id      Int?
  clinic_id      Int?
  admin_id       Int?
  start_time     DateTime? @db.Time(0)
  end_time       DateTime? @db.Time(0)
  slot_duration  Int?
  day_of_week    Int      @db.TinyInt
  effective_from DateTime @db.Date
  effective_to   DateTime @db.Date

  doctor doctors? @relation(fields: [doctor_id], references: [doctor_id])
  clinic clinics? @relation(fields: [clinic_id], references: [clinic_id])
  admin  admins?  @relation(fields: [admin_id], references: [admin_id])
  slots  slots[]
}

model conversation_sessions {
  user_id             String   @id @db.VarChar(255)
  state               String   @db.VarChar(255)
  context_json        String   @db.Text
  response_language   String   @db.VarChar(50)
  language_locked     Int      @db.TinyInt
  language_turn_count Int
  init_unclear_count  Int
  in_edit_flow        Int      @db.TinyInt
  doctor_id           Int?
  admin_id            Int?
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamp(0)
}

model inbound_message_sids {
  message_sid String   @id @db.VarChar(255)
  user_id     String   @db.VarChar(255)
  body        String?  @db.Text
  received_at DateTime @default(now()) @db.Timestamp(0)
}

model user_tokens {
  token_hash String   @id @db.Char(64)
  user_id    Int
  expires_at DateTime @db.DateTime(0)
  revoked    Int      @db.TinyInt
  created_at DateTime @default(now()) @db.Timestamp(0)

  user users @relation(fields: [user_id], references: [user_id])
}
